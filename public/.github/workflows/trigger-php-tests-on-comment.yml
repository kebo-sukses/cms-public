ssh -i /path/to/private_key -o IdentitiesOnly=yes deploy_user@your-host 'echo OK && whoami'name: Trigger PHP Tests via Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  workflows: write

jobs:
  trigger-php-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Validate comment and dispatch tests
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment && context.payload.comment.body ? context.payload.comment.body.trim() : '';
            const commenter = context.payload.comment && context.payload.comment.user ? context.payload.comment.user.login : null;
            const issueNumber = context.payload.issue ? context.payload.issue.number : null;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const cmd = '/run php-tests';

            if (!comment || !comment.startsWith(cmd)) {
              core.info('No trigger command found in comment, exiting.');
              return;
            }

            if (!commenter || !issueNumber) {
              core.info('Missing commenter or issue number, exiting.');
              return;
            }

            // Check collaborator permission level
            const perm = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username: commenter });
            const level = perm && perm.data && perm.data.permission ? perm.data.permission : 'none';
            const allowed = ['admin', 'write', 'maintain'];
            if (!allowed.includes(level)) {
              await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body: `Sorry @${commenter}, you don't have permission to trigger tests (permission: ${level}).` });
              return;
            }

            // Dispatch the existing php-tests workflow on main
            await github.rest.actions.createWorkflowDispatch({ owner, repo, workflow_id: 'php-tests.yml', ref: 'main' });

            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body: `Test run requested by @${commenter}. Workflow dispatch queued for \\`main\\`.` });
