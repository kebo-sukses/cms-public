name: Build Templates & Notify

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare artifacts directory
        run: mkdir -p artifacts

      - name: Build template ZIPs
        run: |
          set -e
          for d in templates/*; do
            if [ -d "$d" ]; then
              name=$(basename "$d")
              zipfile="artifacts/${name}.zip"
              rm -f "$zipfile"
              zip -r "$zipfile" "$d" >/dev/null
              sha256sum "$zipfile" | awk '{print $1}' > "${zipfile}.sha256"
            fi
          done

      - name: Create GitHub Release (draft)
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: templates-${{ github.sha }}
          name: "Templates ${{ github.sha }}"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send webhook to LuxiePhoto
        if: secrets.LUXIEPHOTO_WEBHOOK_URL
        env:
          WEBHOOK_URL: ${{ secrets.LUXIEPHOTO_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.LUXIEPHOTO_WEBHOOK_SECRET }}
          REPO: ${{ github.repository }}
          TAG: templates-${{ github.sha }}
        run: |
          set -e
          for f in artifacts/*.zip; do
            name=$(basename "$f")
            sha=$(sha256sum "$f" | awk '{print $1}')
            # Construct artifact download URL on the release
            url="https://github.com/${REPO}/releases/download/${TAG}/${name}"
            payload=$(jq -nc --arg site "$REPO" --arg name "$name" --arg url "$url" --arg sha "$sha" --arg ver "${GITHUB_SHA}" '{site:$site,artifact:$name,artifact_url:$url,sha256:$sha,version:$ver,autoApply:false}')
            signature="sha256=$(printf '%s' "$payload" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')"
            echo "Posting webhook for $name to $WEBHOOK_URL"
            curl -fsS -X POST "$WEBHOOK_URL" -H "Content-Type: application/json" -H "X-Signature: $signature" -d "$payload" || echo "Webhook POST failed for $name"
          done
