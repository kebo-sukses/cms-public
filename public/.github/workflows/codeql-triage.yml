name: CodeQL Alert Triage

on:
  # Use manual dispatch by default so this workflow is valid in all repos.
  # If your organization supports CodeQL alert events, you can replace
  # this with `code_scanning_alert` (types: [ 'created', 'reopened', 'retriaged' ]).
  workflow_dispatch:
    inputs:
      alert_id:
        description: 'Optional CodeQL alert number to triage (use when running manually)'
        required: false
        default: ''

permissions:
  actions: read
  code-scanning: read
  issues: write
  workflows: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage CodeQL Alert
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Support manual runs with an `alert_id` input: fetch the alert via API
            const alertId = context.payload && context.payload.inputs && context.payload.inputs.alert_id ? context.payload.inputs.alert_id : null;
            let alert = context.payload.alert || context.payload;
            if (alertId) {
              try {
                core.info(`Fetching CodeQL alert ${alertId} via API`);
                const resp = await github.rest.codeScanning.getAlert({ owner, repo, alert_number: parseInt(alertId, 10) });
                alert = resp.data;
              } catch (e) {
                core.warning(`Failed to fetch alert ${alertId}: ${e.message}`);
              }
            }

            const severity = (alert && alert.rule && alert.rule.severity) || (alert && alert.alert && alert.alert.rule && alert.alert.rule.severity);
            const issueTitle = `CodeQL alert: ${alert && alert.rule && alert.rule.id ? alert.rule.id : alert && alert.rule ? alert.rule : 'unknown'}`;
            const labels = [];
            if (severity === 'error' || severity === 'high') {
              labels.push('security/high');
            } else if (severity === 'warning' || severity === 'medium') {
              labels.push('security/medium');
            } else {
              labels.push('security/low');
            }
            // Create an issue to track the high/medium findings, but avoid duplicates
            if (labels.includes('security/high') || labels.includes('security/medium')) {
              // Check for an existing open issue with the same title
              const q = `repo:${owner}/${repo} in:title "${issueTitle}" state:open`;
              const existing = await github.search.issuesAndPullRequests({ q });
              if (existing.data && existing.data.total_count && existing.data.total_count > 0) {
                core.info(`An open issue already exists for ${issueTitle}, skipping creation.`);
              } else {
                await github.issues.create({ owner, repo, title: issueTitle, body: `A CodeQL alert was raised:\n\n${JSON.stringify(alert, null, 2)}`, labels });
              }
            } else {
              // Add labels to the alert as a note (alerts don't support labels directly)
              core.info(`Low severity CodeQL alert detected: ${JSON.stringify((alert && (alert.rule || alert)), null, 2)}`);
            }