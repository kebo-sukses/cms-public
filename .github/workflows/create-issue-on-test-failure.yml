name: Create issue on PHP Tests failure

on:
  workflow_run:
    workflows: ["PHP Tests"]
    types: [completed]

jobs:
  create-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub issue for failed tests
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = run.head_branch || run.head_sha;
            const title = `CI: PHP Tests failed on ${branch}`;

            // Check for existing open issue with same title to avoid duplicates
            const existing = await github.issues.listForRepo({ owner, repo, state: 'open', labels: 'ci-failure' });
            const found = existing.data.find(i => i.title === title);
            if (found) {
              core.info(`Found existing issue #${found.number}, skipping creation.`);
              return;
            }

            const body = `The **PHP Tests** workflow has failed on branch **${branch}**.\n\n` +
              `Run details: ${run.html_url}\n\n` +
              `Please check the logs and the \`phpunit-output\` artifact (if available).\n\n` +
              `Triggered by commit ${run.head_sha}.`;

            await github.issues.create({ owner, repo, title, body, labels: ['ci-failure'] });