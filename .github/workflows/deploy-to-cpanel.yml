name: Deploy to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy (rsync to cPanel)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Sync to cPanel (staging)
        env:
          DEST_USER: ${{ secrets.DEPLOY_USER }}
          DEST_HOST: ${{ secrets.DEPLOY_HOST }}
          DEST_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          rsync -avz --delete --exclude='.git' --exclude='data' --exclude='tests' --exclude='.github' \
            -e "ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no" ./ "$DEST_USER@$DEST_HOST:$DEST_PATH/_tmp-sync/"

      - name: Atomic swap on remote
        env:
          DEST_USER: ${{ secrets.DEPLOY_USER }}
          DEST_HOST: ${{ secrets.DEPLOY_HOST }}
          DEST_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no $DEST_USER@$DEST_HOST "bash -s" <<'EOF'
            set -euo pipefail
            mkdir -p "$DEST_PATH/backups"
            if [ -d "$DEST_PATH/site" ]; then
              mv "$DEST_PATH/site" "$DEST_PATH/backups/site-$(date +%s)"
            fi
            mv "$DEST_PATH/_tmp-sync" "$DEST_PATH/site"
            # fix permissions (assumes deploy user owns the path)
            chmod -R 755 "$DEST_PATH/site"
            echo "DEPLOY_SUCCESS: $(date -u +%c)"
          EOF

      - name: Notify
        run: echo "Deployment completed"
