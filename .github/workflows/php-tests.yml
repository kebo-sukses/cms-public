name: PHP Tests

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist
      - name: Run PHPUnit
        run: ./vendor/bin/phpunit --configuration phpunit.xml --verbose

  docker-tests:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - name: Cache Composer dependencies (for Docker)
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: docker-composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: docker-composer-${{ runner.os }}-
      - name: Build Docker image
        run: docker build -t calius-tests:latest .
      - name: Run tests in Docker container (with integration tests enabled)
        run: |
          docker run --rm -e ENABLE_INTEGRATION=1 -v ${{ github.workspace }}:/app -v $HOME/.composer/cache:/tmp/composer-cache -e COMPOSER_CACHE_DIR=/tmp/composer-cache -w /app calius-tests:latest \
            bash -lc "composer config cache-dir /tmp/composer-cache && composer install --no-interaction --prefer-dist && ./vendor/bin/phpunit --configuration phpunit.xml --verbose > phpunit-output.txt || (cat phpunit-output.txt && exit 1)"
      - name: Upload test output
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-output
          path: phpunit-output.txt
