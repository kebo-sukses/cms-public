name: "CodeQL Analysis"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1'

jobs:
  analyze:
    name: Analyze (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP (for CodeQL PHP analysis)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer

      - name: Download CodeQL CLI bundle (specific version with retries)
        run: |
          CODEQL_VERSION="v2.23.8"
          URL="https://github.com/github/codeql-cli-binaries/releases/download/${CODEQL_VERSION}/codeql-linux64.zip"
          echo "Downloading CodeQL CLI bundle from $URL"
          n=0
          until [ "$n" -ge 3 ]; do
            curl -sSL "$URL" -o codeql.zip && break
            n=$((n+1))
            echo "Retry $n/3..."
            sleep 2
          done
          file codeql.zip || true
          # Attempt to unzip; if unzip not available, use python fallback
          if command -v unzip >/dev/null 2>&1; then
            unzip -q codeql.zip || (echo "unzip failed; dumping first 200 bytes" && head -c 200 codeql.zip | xxd)
          else
            python - <<'PY'
import zipfile, sys
try:
  with zipfile.ZipFile('codeql.zip') as z:
    z.extractall()
except Exception as e:
  sys.exit(0)
PY
          fi
          echo "--- extraction result (pwd) ---"
          ls -la || true
          if [ -d codeql ]; then
            echo "codeql directory exists; making cli executable"
            chmod +x codeql/codeql || true
          else
            echo "codeql directory not found after unzip"
          fi
          echo "$(pwd)/codeql" >> $GITHUB_PATH

      - name: Ensure PHP CodeQL packs are installed (fallback)
        run: |
          # Ensure codeql CLI is available
          if [ -x "./codeql/codeql" ]; then
            ./codeql/codeql --version
            ./codeql/codeql pack install codeql/php-all@latest || ./codeql/codeql pack install codeql/php-all@latest --no-verify
          else
            echo "codeql CLI not found; will rely on action's init to install packs"
          fi

      - name: Diagnose CodeQL language availability (non-fatal)
        continue-on-error: true
        run: |
          echo "--- Diagnosing CodeQL languages ---"
          if [ -x "./codeql/codeql" ]; then
            echo "CodeQL CLI found at ./codeql/codeql"
            set +e
            ./codeql/codeql resolve languages --format=json > codeql-langs.json 2>/dev/null || true
            echo "Contents of codeql-langs.json (trimmed):"
            head -n 200 codeql-langs.json || true
            if grep -q '"php"' codeql-langs.json 2>/dev/null; then
              echo "php extractor is present in resolved languages"
            else
              echo "php extractor NOT present â€” attempting a test database create (non-fatal)"
              ./codeql/codeql database create codeql-db-php --language=php --source-root=. || true
            fi
            set -e
          else
            echo "CodeQL CLI not found; cannot diagnose. Will rely on action's init step."
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: php
          packs: codeql/php-all@latest

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
